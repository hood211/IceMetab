---
title: "NEP Analyses"
author: "JMH"
date: "11/24/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo= FALSE}
library(tidyverse)
library(here)
library(mgcViz)
library(MuMIn)
library(mgcv)
library(forecast)
library(gridExtra)
```

# Load & munge data
```{r}
# load(file.path(here::here("04_SavedImages"), "03_NEPanalyses_rdat"))
```


DOY < 183 already removed
```{r message=FALSE, warning=FALSE}
met <- readr::read_csv(file = file.path(here::here("01_Data"),"03_PostGPPmet.csv")) %>% 
  mutate(stream = fct_relevel(stream, c("st11U", "st18", "st6", "st9")),
         treatment = fct_relevel(treatment, c("ambient", "nitrogen", "phosphorus")),
         Yf = as.factor(Yf),
         streamTreat = as.factor(streamTreat))
```

# NEP Plots
Big differences among treatments. sort of normal
```{r echo=FALSE}
ggplot(met, aes(y = NEP, x = doy, color = treatment)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(vars(stream))
```

```{r echo=FALSE}
ggplot(met, aes(sample = NEP, color = stream)) +stat_qq() + stat_qq_line() +
  facet_grid(.~stream)
```

# GAMMS

## Determine ARMA model

Preliminary analysis indicated that there was significant autocorrelation. So the first step is to determine the autocorrelation structure. We'll use what is sort of a global model.

```{r}
# g.nep.AC_1.0 <- gamm(NEP ~ treatment + invKT.C.StMean + Tanom.iktCs +
#                      s(Qres, by = stream) + s(doy, by = stream) + s(LightPerDay.lcg),
#                 correlation = corARMA(p = 1,q = 0, form = ~ doy | streamTreat), REML = FALSE, data = met,
#                 control = lmeControl(maxIter = 1e8, msMaxIter = 1e8))
# 
# g.nep.AC_1.1 <- gamm(NEP ~ treatment + invKT.C.StMean + Tanom.iktCs +
#                      s(Qres, by = stream) + s(doy, by = stream) + s(LightPerDay.lcg),
#                 correlation = corARMA(p = 1,q = 1, form = ~ doy | streamTreat), REML = FALSE, data = met,
#                 control = lmeControl(maxIter = 1e8, msMaxIter = 1e8))

g.nep.AC_1.2 <- gamm(NEP ~ treatment + invKT.C.StMean + Tanom.iktCs +   
                     s(Qres, by = stream) + s(doy, by = stream) + s(LightPerDay.lcg), 
                correlation = corARMA(p = 1,q = 2, form = ~ doy | streamTreat), REML = FALSE, data = met,
                control = lmeControl(maxIter = 1e8, msMaxIter = 1e8))

g.nep.AC_2.0 <- gamm(NEP ~ treatment + invKT.C.StMean + Tanom.iktCs +   
                     s(Qres, by = stream) + s(doy, by = stream) + s(LightPerDay.lcg), 
                correlation = corARMA(p = 2,q = 0, form = ~ doy | streamTreat), REML = FALSE, data = met,
                control = lmeControl(maxIter = 1e8, msMaxIter = 1e8))

# g.nep.AC_2.1 <- gamm(NEP ~ treatment + invKT.C.StMean + Tanom.iktCs +
#                      s(Qres, by = stream) + s(doy, by = stream) + s(LightPerDay.lcg),
#                 correlation = corARMA(p = 2,q = 1, form = ~ doy | streamTreat), REML = FALSE, data = met,
#                 control = lmeControl(maxIter = 1e8, msMaxIter = 1e8))

g.nep.AC_2.2 <- gamm(NEP ~ treatment + invKT.C.StMean + Tanom.iktCs +   
                     s(Qres, by = stream) + s(doy, by = stream) + s(LightPerDay.lcg), 
                correlation = corARMA(p = 2,q = 2, form = ~ doy | streamTreat), REML = FALSE, data = met,
                control = lmeControl(maxIter = 1e8, msMaxIter = 1e8))

g.nep.AC_3.0 <- gamm(NEP ~ treatment + invKT.C.StMean + Tanom.iktCs +   
                     s(Qres, by = stream) + s(doy, by = stream) + s(LightPerDay.lcg), 
                correlation = corARMA(p = 3,q = 0, form = ~ doy | streamTreat), REML = FALSE, data = met,
                control = lmeControl(maxIter = 1e8, msMaxIter = 1e8))

g.nep.AC_3.1 <- gamm(NEP ~ treatment + invKT.C.StMean + Tanom.iktCs +
                     s(Qres, by = stream) + s(doy, by = stream) + s(LightPerDay.lcg),
                correlation = corARMA(p = 3,q = 1, form = ~ doy | streamTreat), REML = FALSE, data = met,
                control = lmeControl(maxIter = 1e8, msMaxIter = 1e8))

g.nep.AC_3.2 <- gamm(NEP ~ treatment + invKT.C.StMean + Tanom.iktCs +   
                     s(Qres, by = stream) + s(doy, by = stream) + s(LightPerDay.lcg), 
                correlation = corARMA(p = 3,q = 2, form = ~ doy | streamTreat), REML = FALSE, data = met,
                control = lmeControl(maxIter = 1e8, msMaxIter = 1e8))

g.nep.AC_3.3 <- gamm(NEP ~ treatment + invKT.C.StMean + Tanom.iktCs +   
                     s(Qres, by = stream) + s(doy, by = stream) + s(LightPerDay.lcg), 
                correlation = corARMA(p = 3,q = 3, form = ~ doy | streamTreat), REML = FALSE, data = met,
                control = lmeControl(maxIter = 1e8, msMaxIter = 1e8))

g.nep.AC_3.4 <- gamm(NEP ~ treatment + invKT.C.StMean + Tanom.iktCs +   
                     s(Qres, by = stream) + s(doy, by = stream) + s(LightPerDay.lcg), 
                correlation = corARMA(p = 3,q = 4, form = ~ doy | streamTreat), REML = FALSE, data = met,
                control = lmeControl(maxIter = 1e8, msMaxIter = 1e8))

g.nep.AC_4.0 <- gamm(NEP ~ treatment + invKT.C.StMean + Tanom.iktCs +   
                     s(Qres, by = stream) + s(doy, by = stream) + s(LightPerDay.lcg), 
                correlation = corARMA(p = 4,q = 0, form = ~ doy | streamTreat), REML = FALSE, data = met,
                control = lmeControl(maxIter = 1e8, msMaxIter = 1e8))

g.nep.AC_4.1 <- gamm(NEP ~ treatment + invKT.C.StMean + Tanom.iktCs +   
                     s(Qres, by = stream) + s(doy, by = stream) + s(LightPerDay.lcg), 
                correlation = corARMA(p = 4,q = 1, form = ~ doy | streamTreat), REML = FALSE, data = met,
                control = lmeControl(maxIter = 1e8, msMaxIter = 1e8))

# g.nep.AC_4.2 <- gamm(NEP ~ treatment + invKT.C.StMean + Tanom.iktCs +   
#                      s(Qres, by = stream) + s(doy, by = stream) + s(LightPerDay.lcg), 
#                 correlation = corARMA(p = 4,q = 2, form = ~ doy | streamTreat), REML = FALSE, data = met,
#                 control = lmeControl(maxIter = 1e8, msMaxIter = 1e8))

# g.nep.AC_4.3 <- gamm(NEP ~ treatment + invKT.C.StMean + Tanom.iktCs +   
#                      s(Qres, by = stream) + s(doy, by = stream) + s(LightPerDay.lcg), 
#                 correlation = corARMA(p = 4,q = 3, form = ~ doy | streamTreat), REML = FALSE, data = met,
#                 control = lmeControl(maxIter = 1e8, msMaxIter = 1e8))

# g.nep.AC_4.4 <- gamm(NEP ~ treatment + invKT.C.StMean + Tanom.iktCs +   
#                      s(Qres, by = stream) + s(doy, by = stream) + s(LightPerDay.lcg), 
#                 correlation = corARMA(p = 4,q = 4, form = ~ doy | streamTreat), REML = FALSE, data = met,
#                 control = lmeControl(maxIter = 1e8, msMaxIter = 1e8))

```

Model selection indicates that 3_2 is the best model.
```{r echo= FALSE}
model.sel(#g.nep.AC_1.0$lme, g.nep.AC_1.1$lme, 
          g.nep.AC_1.2$lme, 
          g.nep.AC_2.0$lme, #g.nep.AC_2.1$lme, 
          g.nep.AC_2.2$lme, 
          g.nep.AC_3.0$lme, #g.nep.AC_3.1$lme, 
          g.nep.AC_3.2$lme, g.nep.AC_3.3$lme,
          g.nep.AC_4.0$lme, g.nep.AC_4.1$lme)#g.nep.AC_4.2$lme, g.nep.AC_4.3$lme
          
```

ACF: Looks great. One sig lag in  S18N
```{r echo= FALSE}

# https://www.kaggle.com/timib1203/managing-many-models-with-tidyr-purrr-and-broom
# https://jroy042.github.io/nonlinear/week4.html
# https://stackoverflow.com/questions/47586110/autocorrelation-in-generalized-additive-models-gam
g.nep.AC_best.acf <- met %>% 
  mutate(g.nepRes = resid(g.nep.AC_3.2$lme, type = "normalized")) %>% 
  select(streamTreat, g.nepRes) %>% 
  group_by(streamTreat) %>% 
  nest() %>% 
  mutate(acf = map(.x = data, .f = function(d) ggAcf(d$g.nepRes) + labs(title = streamTreat)))
```

```{r echo= FALSE}
grid.arrange(grobs = g.nep.AC_best.acf$acf, ncol = 3)
```

```{r echo= FALSE}
BestNEPCor <- corARMA(p = 3,q = 2, form = ~ doy | streamTreat)
```



## Model selection
```{r echo=FALSE, include = FALSE}
# full interation model won't run so doing this instead.
g.nep.modsel1 <- uGamm(NEP ~ treatment * invKT.C.StMean + treatment * Tanom.iktCs + invKT.C.StMean* Tanom.iktCs +
                     s(Qres, by = stream) + s(doy, by = stream) + s(LightPerDay.lcg),
                correlation = BestNEPCor, REML = FALSE, data = met,
                control = lmeControl(maxIter = 1e8, msMaxIter = 1e8), class = "gamm")

g.nep.modsel2 <- uGamm(NEP ~ treatment * invKT.C.StMean * Tanom.iktCs +
                     s(Qres) + s(doy, by = stream) + s(LightPerDay.lcg),
                correlation = BestNEPCor, REML = FALSE, data = met,
                control = lmeControl(maxIter = 1e8, msMaxIter = 1e8), class = "gamm")

g.nep.modsel3 <- uGamm(NEP ~ treatment * invKT.C.StMean * Tanom.iktCs +
                     s(Qres, by = stream) + s(doy) + s(LightPerDay.lcg),
                correlation = BestNEPCor, REML = FALSE, data = met,
                control = lmeControl(maxIter = 1e8, msMaxIter = 1e8), class = "gamm")

# full interaction won't work
g.nep.modsel4 <- uGamm(NEP ~ treatment + invKT.C.StMean + treatment * Tanom.iktCs + invKT.C.StMean* Tanom.iktCs +
                     s(Qres, by = stream) + s(doy, by = streamTreat) + s(LightPerDay.lcg),
                correlation = BestNEPCor, REML = FALSE, data = met,
                control = lmeControl(maxIter = 1e8, msMaxIter = 1e8), class = "gamm")

g.nep.Dredge_1 <-  dredge(global.model = g.nep.modsel1, evaluate = TRUE, rank = AIC)
g.nep.Dredge_2 <-  dredge(global.model = g.nep.modsel2, evaluate = TRUE, rank = AIC)
g.nep.Dredge_3 <-  dredge(global.model = g.nep.modsel3, evaluate = TRUE, rank = AIC)
g.nep.Dredge_4 <-  dredge(global.model = g.nep.modsel4, evaluate = TRUE, rank = AIC)
```

The first one didn't work
```{r echo=FALSE}
g.nepDredgeSum0 <- merge(g.nep.Dredge_1, g.nep.Dredge_2)
g.nepDredgeSum1 <- merge(g.nepDredgeSum0, g.nep.Dredge_3)
g.nepDredgeSumF <- merge(g.nepDredgeSum1, g.nep.Dredge_4)
```


1 top model (two are same). All models have a three way interaction. Top models do not have DOY or Q
```{r}
subset(g.nepDredgeSumF, delta <= 10)
```

```{r echo=FALSE}
g.nepBEST1 <- gamm(NEP ~ treatment * invKT.C.StMean * Tanom.iktCs +   
                     s(LightPerDay.lcg), 
                correlation = BestNEPCor, REML = TRUE, data = met,
                control = lmeControl(maxIter = 1e8, msMaxIter = 1e8))
```

```{r echo=FALSE}
g.nepBEST2 <- gamm(NEP ~ treatment * invKT.C.StMean * Tanom.iktCs +   
                     s(LightPerDay.lcg) + s(doy), 
                correlation = BestNEPCor, REML = TRUE, data = met,
                control = lmeControl(maxIter = 1e8, msMaxIter = 1e8))

# just trying for a model with decent residuals
g.nepBEST3 <- gamm(NEP ~ treatment + invKT.C.StMean + treatment * Tanom.iktCs + invKT.C.StMean* Tanom.iktCs  +
                     s(LightPerDay.lcg) + s(doy, by = streamTreat), 
                correlation = BestNEPCor, REML = TRUE, data = met,
                control = lmeControl(maxIter = 1e8, msMaxIter = 1e8))
```


NEP ~ treatment * invKT.C.StMean * Tanom.iktCs + s(LightPerDay.lcg)
R2 = 0.626
Sig N X stream Temp X daily temp
Sig P
```{r echo=FALSE}
summary(g.nepBEST1$gam)
```


NEP ~ treatment * invKT.C.StMean * Tanom.iktCs + s(LightPerDay.lcg) + s(doy)
R2 = 0.628
doy is NS
Sig N X stream Temp X daily temp
Sig P
```{r}
summary(g.nepBEST2$gam)
```


```{r}
summary(g.nepBEST3$gam)
```


Concurvity looks pretty good
```{r echo=FALSE}
round(concurvity(g.nepBEST1$gam, full = FALSE)$estimate,3)
```


```{r echo=FALSE}
g.nep.BEST1.gv <- getViz(g.nepBEST1$gam)
```


There are problems here
```{r}
check(g.nep.BEST1.gv)
```

Who's causing these problems
```{r}
metBestTest <- met %>% 
  mutate(nepRes1 = residuals(g.nepBEST1$gam, type = "response"),
         nepPred1 = predict(g.nepBEST1$gam, type = "response"),
         nepRes3 = residuals(g.nepBEST3$gam, type = "response"),
         nepPred3 = predict(g.nepBEST3$gam, type = "response"))
```

What on earth!
S6 has a doy issue, so does 9
```{r}
ggplot(metBestTest, aes(x = NEP, y = nepPred1, shape = treatment, color = doy)) +
  geom_point() +
  facet_grid(stream ~.) +
  geom_abline(intercept = 0, slope = 1) +
  scale_color_gradient(low = "white", high = "red")
```

This one is a lot better
```{r}
ggplot(metBestTest, aes(x = NEP, y = nepPred3, shape = treatment, color = doy)) +
  geom_point() +
  facet_grid(stream ~.) +
  geom_abline(intercept = 0, slope = 1) +
  scale_color_gradient(low = "white", high = "red")
```

```{r}
ggplot(metBestTest, aes(y = nepRes1, x = NEP, shape = stream, color = treatment)) +
  geom_point() +
  facet_grid(stream ~.) +
  geom_abline(intercept = 0, slope = 0)
```



This seems fine
```{r}
ggplot(metBestTest, aes(y = nepRes1, x = doy, shape = stream, color = treatment)) +
  geom_point() +
  facet_grid(stream ~.) +
  geom_abline(intercept = 0, slope = 0)
```

no problem here
```{r}
ggplot(metBestTest, aes(y = nepRes1, x = LightPerDay.lcg, shape = stream, color = treatment)) +
  geom_point() +
  facet_grid(stream ~.) +
  geom_abline(intercept = 0, slope = 0)
```

no problem here
```{r}
ggplot(metBestTest, aes(y = nepRes1, x = Qres, shape = stream, color = treatment)) +
  geom_point() +
  facet_grid(stream ~.) +
  geom_abline(intercept = 0, slope = 0)
```

```{r}
ggplot(metBestTest, aes(y = nepRes1, x = NEP, color = stream)) +
  geom_point()
```



These aren't too useful for interactions
```{r echo=FALSE}
NEPquickPlot1 <- plot(g.nep.BEST1.gv, allTerms = 1) +
  l_points(color = "pink") + l_fitLine(linetype = 3) + l_fitContour() + 
      l_ciLine(colour = 2) + l_ciBar() + l_fitPoints(size = 1, col = 2) + theme_get() + labs(title = NULL)

  print(NEPquickPlot1, pages = 1)
```



Predict for future ploting
```{r echo= FALSE}
# met$GPPgamPred <- predict.gam(g.gpp.best$gam, met, type = "response")
# met$GPPgamPred.se <- predict.gam(g.gpp.best$gam, met, type = "response", se.fit = TRUE)$se.fit
```

Export
```{r}
# readr::write_csv(met, file.path(here::here("01_Data"), "03_PostGPPmet.csv"))
```

```{r}
save.image(file.path(here::here("04_SavedImages"), "04_NEPanalyses_rdat"))
# load(file.path(here::here("04_SavedImages"), "03_GPPanalyses_rdat"))
```

