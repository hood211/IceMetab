---
title: "NEP analysis"
author: "JMH"
date: "11/13/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---


# Analysis of ER response to N and P enrichment
## Libraries
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(gamm4)
library(mgcViz)
library(MuMIn)
library(forecast)
library(gridExtra)
library(tidymv)

```

## Load & munge data

Loads data, calculates log GPP and ER, does a ridiculous transformation of NEP, and centers stream water temp at 10C as inverse kT
```{r message=FALSE, warning=FALSE}
met2 <- read.csv("00_metab_for_Hoodie.csv") %>% 
  mutate(Pdt = as.POSIXct(Pdt, format = "%m/%d/%y"),
         doy = as.numeric(strftime(Pdt, format = "%j")),
         Y = as.numeric(strftime(Pdt, format = "%Y")),
         Yf = as.factor(as.character(Y)),
         lGPP = log(GPP_median),
         lER = log(-ER_median),
         #centering
         invKT.C = one_over_kT - 1/((10 + 273.15)*0.0000862),
         streamTreat = as.factor(paste0(stream,"_",treatment))) %>% 
  mutate_at(vars(stream, treatment), funs(as.factor(.))) %>% 
  rename(invKT = one_over_kT)
```

For predictor variables, we want to center Temp, light, Q, and GPP. We'll do that using stream means, which we calculate below
```{r}
# stream mean
metS <- met2 %>% 
  group_by(stream, treatment) %>% 
  summarise_at(vars(meanTemp, invKT.C, meanQds, LightPerDay, lGPP), funs(mean(., na.rm = TRUE))) %>% 
  group_by(stream) %>% 
  summarise_at(vars(meanTemp, invKT.C, meanQds, LightPerDay, lGPP), funs(mean(., na.rm = TRUE))) %>% 
  rename_at(vars(-stream), function(x) paste0(x,".StMean"))

# global mean
metG0 <- met2 %>% 
  group_by(stream, treatment) %>% 
  summarise_at(vars(meanTemp, invKT.C, meanQds, LightPerDay, lGPP), funs(mean(., na.rm = TRUE))) %>% 
  group_by(stream) %>% 
  summarise_at(vars(meanTemp, invKT.C, meanQds, LightPerDay, lGPP), funs(mean(., na.rm = TRUE))) %>% 
  group_by() %>% 
  summarise_at(vars(meanTemp, invKT.C, meanQds, LightPerDay, lGPP), funs(mean(., na.rm = TRUE)))%>% 
  rename_at(vars(meanTemp:lGPP), function(x) paste0(x,".GMean"))

metG <- rbind(metG0, metG0, metG0, metG0)
metG$stream <- c("st11U", "st18", "st6", "st9")
```

Now, we log transform Q, GPP, and light then center on mean logged value (you can't center then log). 
```{r}
met <- met2 %>% 
  full_join(metS, by = "stream") %>% 
  full_join(metG, by = "stream") %>% 
  #these are centered on the stream mean
  mutate(Tanom.iktCs = invKT.C - invKT.C.StMean, 
         Tanom.iktCg = invKT.C - invKT.C.GMean, 
         Tanom.Cs = meanTemp - meanTemp.StMean,
         Tanom.Cg = meanTemp - meanTemp.GMean,
         LightPerDayCs = LightPerDay - LightPerDay.StMean,
         LightPerDayCg = LightPerDay - LightPerDay.GMean,
         meanQdsCs = meanQds - meanQds.StMean,
         meanQdsCg = meanQds - meanQds.GMean,
         LightPerDay.l = log(LightPerDay),
         meanQds.l = log(meanQds),
         LightPerDay.lcs = LightPerDay.l - log(LightPerDay.StMean),
         LightPerDay.lcg = LightPerDay.l - log(LightPerDay.GMean),
         meanQds.lcs = meanQds.l - log(meanQds.StMean),
         meanQds.lcg = meanQds.l - log(meanQds.GMean),
         lGPP.cs = lGPP - lGPP.StMean,
         lGPP.cg = lGPP - lGPP.GMean,
         streamTreat = paste0(stream," ", treatment),
         stream = as.factor(stream))
```


## Quick visualization
### NEP
Focus on NEP response.


```{r echo=FALSE}
ggplot(met, aes(y = NEP, x = doy, color = Yf)) +
  geom_line() +
  facet_grid(. ~ stream)
```

Access normality: 
NEP - not terrible
giving weird residuals, not sure what I can do

```{r echo=FALSE}
ggplot(met, aes(sample = NEP, color = stream)) +stat_qq() + stat_qq_line() +
  facet_grid(.~stream)
```



```{r echo=FALSE}
ggplot(met, aes(sample = asinh(NEP), color = stream)) +stat_qq() + stat_qq_line() +
  facet_grid(.~stream)
```

```{r}
ggplot(met, aes(sample = NEP^1/3, color = stream)) +stat_qq() + stat_qq_line() +
  facet_grid(.~stream)
```

```{r}
library(car)
ggplot(met, aes(sample = log(NEP+100), color = stream)) +stat_qq() + stat_qq_line() +
  facet_grid(.~stream)

```


# NEP models

Likely maximal models
model with light won't converge with a 'by = stream'

```{r}
g.nep.PutGLOB0s <- gamm(NEP ~ treatment*invKT.C.StMean +  s(meanQds.lcs, by = stream) , REML = FALSE, data = met)
g.nep.PutGLOB1s <- gamm(NEP ~ treatment*invKT.C.StMean +  s(meanQds.lcs, by = stream) + 
                     s(LightPerDay.lcg), REML = FALSE, data = met)

```

Light model is massively better
```{r}
model.sel(g.nep.PutGLOB0s$lme, g.nep.PutGLOB1s$lme)
```


```{r}
summary(g.nep.PutGLOB1s$gam)
```

```{r}
g.nep.PutGLOB1s.b <- getViz(g.nep.PutGLOB1s$gam)
```

Bit funky around zero good
```{r}
check(g.nep.PutGLOB1s.b)
```


So autocorrelation
```{r}
# https://www.kaggle.com/timib1203/managing-many-models-with-tidyr-purrr-and-broom
met.PutGLOB <- met %>% 
  mutate(g.nepRes = resid(g.nep.PutGLOB1s$lme, type = "normalized")) %>% 
  select(streamTreat, g.nepRes) %>% 
  group_by(streamTreat) %>% 
  nest() %>% 
  mutate(acf = map(.x = data, .f = function(d) ggAcf(d$g.nepRes) + labs(title = streamTreat)))
```


```{r}
grid.arrange(grobs = met.PutGLOB$acf, ncol = 3)
```

Evaluate different corr structures
```{r}
g.nep.AC_1.0 <- gamm(NEP ~ treatment*invKT.C.StMean +  s(meanQds.lcs, by = stream) + 
                     s(LightPerDay.lcg), 
                correlation = corARMA(p = 1,q = 0, form = ~ doy | streamTreat), REML = FALSE, data = met)

g.nep.AC_1.1 <- gamm(NEP ~ treatment*invKT.C.StMean +  s(meanQds.lcs, by = stream) + 
                      s(LightPerDay.lcg), 
                correlation = corARMA(p = 1,q = 1, form = ~ doy | streamTreat), REML = FALSE, data = met)

g.nep.AC_1.2 <- gamm(NEP ~ treatment*invKT.C.StMean +  s(meanQds.lcs, by = stream) +
                      s(LightPerDay.lcg), 
                correlation = corARMA(p = 1,q = 2, form = ~ doy | streamTreat), REML = FALSE, data = met)

g.nep.AC_2.0 <- gamm(NEP ~ treatment*invKT.C.StMean +  s(meanQds.lcs, by = stream) + 
                      s(LightPerDay.lcg), 
                correlation = corARMA(p = 2,q = 0, form = ~ doy | streamTreat), REML = FALSE, data = met)


g.nep.AC_2.1 <- gamm(NEP ~ treatment*invKT.C.StMean +  s(meanQds.lcs, by = stream) +
                      s(LightPerDay.lcg), 
                correlation = corARMA(p = 2,q = 1, form = ~ doy | streamTreat), REML = FALSE, data = met)

g.nep.AC_2.2 <- gamm(NEP ~ treatment*invKT.C.StMean +  s(meanQds.lcs, by = stream) +
                      s(LightPerDay.lcg), 
                correlation = corARMA(p = 2,q = 2, form = ~ doy | streamTreat), REML = FALSE, data = met)

g.nep.AC_3.0 <- gamm(NEP ~ treatment*invKT.C.StMean +  s(meanQds.lcs, by = stream) +
                      s(LightPerDay.lcg), 
                correlation = corARMA(p = 3,q = 0, form = ~ doy | streamTreat), REML = FALSE, data = met)

g.nep.AC_3.1 <- gamm(NEP ~ treatment*invKT.C.StMean +  s(meanQds.lcs, by = stream) +
                      s(LightPerDay.lcg), 
                correlation = corARMA(p = 3,q = 1, form = ~ doy | streamTreat), REML = FALSE, data = met)
# 
g.nep.AC_3.2 <- gamm(NEP ~ treatment*invKT.C.StMean +  s(meanQds.lcs, by = stream) +
                      s(LightPerDay.lcg), 
                correlation = corARMA(p = 3,q = 2, form = ~ doy | streamTreat), REML = FALSE, data = met)
```

Model selection
pretty much all equally good, will use the same as gpp
```{r}
model.sel(g.nep.AC_1.0$lme, g.nep.AC_1.1$lme, g.nep.AC_1.2$lme, g.nep.AC_2.0$lme,
          g.nep.AC_2.1$lme, g.nep.AC_2.2$lme, g.nep.AC_3.0$lme, g.nep.AC_3.1$lme, g.nep.AC_3.2$lme) 

```

Not looking so good. I tried a bunch of these and none improved things. 
```{r}

# https://www.kaggle.com/timib1203/managing-many-models-with-tidyr-purrr-and-broom
# https://jroy042.github.io/nonlinear/week4.html
# https://stackoverflow.com/questions/47586110/autocorrelation-in-generalized-additive-models-gam
g.nep.AC_best.acf <- met %>% 
  mutate(g.nepRes = resid(g.nep.AC_2.2$lme, type = "normalized")) %>% 
  select(streamTreat, g.nepRes) %>% 
  group_by(streamTreat) %>% 
  nest() %>% 
  mutate(acf = map(.x = data, .f = function(d) ggAcf(d$g.nepRes) + labs(title = streamTreat)))
```

```{r}
grid.arrange(grobs = g.nep.AC_best.acf$acf, ncol = 3)
```

```{r}
BestNEPCor <- corARMA(p = 2,q = 2, form = ~ doy | streamTreat)
```

```{r}
# STREAM CENTgppED Q
g.nep.NutXTs <- gamm(NEP ~ treatment*invKT.C.StMean +  s(meanQds.lcs, by = stream)+
                      s(LightPerDay.lcg),
                correlation = BestNEPCor, REML = FALSE, data = met)

g.nep.NutpTs <- gamm(NEP ~ treatment + invKT.C.StMean +  s(meanQds.lcs, by = stream)+
                      s(LightPerDay.lcg),
                correlation = BestNEPCor, REML = FALSE, data = met)

g.nep.NutXsts <- gamm(NEP ~ treatment*stream +  s(meanQds.lcs, by = stream)+
                      s(LightPerDay.lcg),
                correlation = BestNEPCor, REML = FALSE, data = met)

g.nep.Nutpsts <- gamm(NEP ~ treatment + stream +  s(meanQds.lcs, by = stream)+
                      s(LightPerDay.lcg),
                correlation = BestNEPCor, REML = FALSE, data = met)

g.nep.Nuts <- gamm(NEP ~ treatment +  s(meanQds.lcs, by = stream)+
                      s(LightPerDay.lcg),
                correlation = BestNEPCor, REML = FALSE, data = met)

g.nep.Ts <- gamm(NEP ~ invKT.C.StMean +  s(meanQds.lcs, by = stream)+
                      s(LightPerDay.lcg),
                correlation = BestNEPCor, REML = FALSE, data = met)

g.nep.sts <- gamm(NEP ~ stream +  s(meanQds.lcs, by = stream)+
                      s(LightPerDay.lcg),
                correlation = BestNEPCor, REML = FALSE, data = met)

g.nep.nulls <- gamm(NEP ~ s(meanQds.lcs, by = stream)+
                      s(LightPerDay.lcg),
                correlation = BestNEPCor, REML = FALSE, data = met) 

g.nep.nullsnoL <- gamm(NEP ~ s(meanQds.lcs, by = stream),
                correlation = BestNEPCor, REML = FALSE, data = met) 

g.nep.nullnoQs <- gamm(NEP ~ s(LightPerDay.lcg),
                correlation = BestNEPCor, REML = FALSE, data = met) 

```

The best model is Nut X stream
Temp comes in at delAIC of ~8 Nut +T
```{r}
model.sel(g.nep.NutXTs$lme, g.nep.NutpTs$lme, g.nep.NutXsts$lme, g.nep.Nutpsts$lme, g.nep.Nuts$lme, g.nep.Ts$lme, g.nep.sts$lme, g.nep.nulls$lme,
          g.nep.nullsnoL$lme, g.nep.nullnoQs$lme)
```

The best model. see above. Also looking at the nutrient + T model.
```{r}
g.nep.best <-  gamm(NEP ~ treatment*stream +  s(meanQds.lcs, by = stream)+
                      s(LightPerDay.lcg),
                correlation = BestNEPCor, REML = TRUE, data = met)
g.nep.bestTps <-  gamm(NEP ~ treatment + stream +  s(meanQds.lcs, by = stream)+
                      s(LightPerDay.lcg),
                correlation = BestNEPCor, REML = TRUE, data = met)
g.nep.bestTpT <-  gamm(NEP ~ treatment + invKT.C.StMean +  s(meanQds.lcs, by = stream)+
                      s(LightPerDay.lcg),
                correlation = BestNEPCor, REML = TRUE, data = met)
```


Nutrient + T model has an R2 nearly 0.3 lower! Sig effect of N and P; Temp isn't sig.
```{r}
summary(g.nep.best$gam)
g.nep.best.b <- getViz(g.nep.best$gam)

summary(g.nep.bestTps$gam)
g.nep.bestTps.b <- getViz(g.nep.bestTps$gam)

summary(g.nep.bestTpT$gam)
g.nep.bestTpT.b <- getViz(g.nep.bestTpT$gam)
```


Pretty good model
```{r}
check(g.nep.best.b)
```



Autocorrelation
still some problems
```{r}
g.nep.best.acf <- met %>% 
  mutate(g.nepRes = resid(g.nep.best$lme, type = "normalized")) %>% 
  select(streamTreat, g.nepRes) %>% 
  group_by(streamTreat) %>% 
  nest() %>% 
  mutate(acf = map(.x = data, .f = function(d) ggAcf(d$g.nepRes) + labs(title = streamTreat)))
```

```{r}
grid.arrange(grobs = g.nep.best.acf$acf, ncol = 3)
```



```{r}
NEPmod1 <- plot(g.nep.best.b, allTerms = 1) +
  l_points(color = "blue") + l_fitLine(linetype = 3) + l_fitContour() + 
      l_ciLine(colour = 2) + l_ciBar() + l_fitPoints(size = 1, col = 2) + theme_get() + labs(title = NULL)

print(NEPmod1, pages = 1)
```


```{r}
NEPmod.pred <- predict_gam(g.nep.best$gam, exclude_terms = c("s(meanQds.lcs)", "s(LightPerDay.lcg)"),
                                          values = list(meanQds.lcs = 0, LightPerDay.lcg = 0))
```


```{r}
NEPseAES <- aes(ymin = fit - se.fit, ymax = fit + se.fit, x = treatment)
ggplot() +
  geom_point(data = met, aes(y = NEP, x = treatment), position = "jitter", color = "grey30", size =1, alpha = 0.5) +
  geom_point(data = NEPmod.pred, aes(y = fit, x = treatment), color = "blue", size =4) +
  geom_errorbar(data = NEPmod.pred, NEPseAES, color = "blue") +
  facet_grid(. ~ stream) +
  theme_bw()
```

```{r fig.height=3, fig.width=8}
ggplot(met, aes(y = GPP_median, x = -ER_median, color = treatment)) +
  geom_point() +
  facet_grid(. ~stream) +
  geom_abline(intercept =0, slope =1)
```








```{r include = FALSE}
# save.image("03_NEPanalysis_rdat")
```


